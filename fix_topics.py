import json

# ====================================================================
# –®–ê–ì 1: –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏–∏ –Ω–∞–∑–≤–∞–Ω–∏–π –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –º–µ–¥–≤—É–∑–æ–º
# ====================================================================
TOPIC_MAPPING = {
    "–ò–º–º—É–Ω–æ–¥–µ—Ñ–∏—Ü–∏—Ç—ã": "–ò–º–º—É–Ω–æ–ª–æ–≥–∏—è",
    "–í–∞–∫—Ü–∏–Ω—ã": "–ò–Ω—Ñ–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –±–æ–ª–µ–∑–Ω–∏",
    "–≠—Ç–∏–∫–∞": "–ü–µ–¥–∏–∞—Ç—Ä–∏—è",
    "–û—Ä—Ç–æ": "–û—Ä—Ç–æ–ø–µ–¥–∏—è",
    "–ù—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥–∏—è": "–ü–µ–¥–∏–∞—Ç—Ä–∏—è",
    "–°–∏–Ω–∫–æ–ø–µ": "–ö–∞—Ä–¥–∏–æ–ª–æ–≥–∏—è",
    "–ù–µ—Ä–≤–Ω–æ-–º—ã—à–µ—á–Ω—ã–µ": "–ù–µ–≤—Ä–æ–ª–æ–≥–∏—è",
    "–≠–ø–∏–ª–µ–ø—Ç–æ–ª–æ–≥–∏—è": "–ù–µ–≤—Ä–æ–ª–æ–≥–∏—è",
    "–í–ü–°": "–ö–∞—Ä–¥–∏–æ–ª–æ–≥–∏—è",
    "–ê—Ä–∏—Ç–º–æ–ª–æ–≥–∏–∏": "–ö–∞—Ä–¥–∏–æ–ª–æ–≥–∏—è",
    "–¢—É–±—É–ª–æ–ø–∞—Ç–∏–∏": "–ù–µ—Ñ—Ä–æ–ª–æ–≥–∏—è",
    "–§—Ç–∏–∑–∏–∞—Ç—Ä–∏—è": "–ò–Ω—Ñ–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –±–æ–ª–µ–∑–Ω–∏",
    "–¢–æ–∫—Å–∏–∫–æ–ª–æ–≥–∏—è": "–ù–µ–æ—Ç–ª–æ–∂–Ω–∞—è –ø–æ–º–æ—â—å",
    "–ê–ª–ª–µ—Ä–≥–æ–ª–æ–≥–∏—è": "–ò–º–º—É–Ω–æ–ª–æ–≥–∏—è",
    "–õ–∞–∫—Ç–∞—Ü–∏—è": "–ü–µ–¥–∏–∞—Ç—Ä–∏—è",
    "–§–∞—Ä–º–∞–∫–æ–ª–æ–≥–∏—è": "–ü–µ–¥–∏–∞—Ç—Ä–∏—è",
    "–ü—Å–∏—Ö–æ—Å–æ–º–∞—Ç–∏–∫–∞": "–ü–µ–¥–∏–∞—Ç—Ä–∏—è",
    "–ê–î": "–ö–∞—Ä–¥–∏–æ–ª–æ–≥–∏—è",
    "–õ–û–†": "–ü–µ–¥–∏–∞—Ç—Ä–∏—è",
    "–ó–æ–æ–Ω–æ–∑—ã": "–ò–Ω—Ñ–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –±–æ–ª–µ–∑–Ω–∏"
}

# 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
try:
    with open("questions.json", encoding="utf-8") as f:
        data = json.load(f)
except FileNotFoundError:
    print("‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª 'questions.json' –Ω–µ –Ω–∞–π–¥–µ–Ω.")
    exit()
except json.JSONDecodeError as e:
    print(f"‚ùå –û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è JSON –≤ 'questions.json': {e}")
    exit()


# 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–º
for q in data:
    topic = q.get("topic", "").strip()
    
    # 2.1. –£–±–∏—Ä–∞–µ–º –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ–º—ã (–±–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ)
    for sep in ["/", ",", "-", "‚Äî"]:
        if sep in topic:
            topic = topic.split(sep)[0].strip()
    
    # 2.2. –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏—è: –ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    # –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º —Å–ª–æ–≤–∞—Ä—å –∑–∞–º–µ–Ω, –µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
    standard_topic = topic.capitalize() 

    if standard_topic in TOPIC_MAPPING:
        q["topic"] = TOPIC_MAPPING[standard_topic]
    else:
        q["topic"] = standard_topic


# 3. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ç–µ–º–µ –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å —Ñ–∞–π–ª–∞
data.sort(key=lambda x: x.get("topic", "").lower())

with open("questions.json", "w", encoding="utf-8") as f:
    json.dump(data, f, ensure_ascii=False, indent=2)

# 4. –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
topics = sorted(set(q["topic"] for q in data))
print("‚úÖ –¢–µ–º—ã —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω—ã, —Å–æ–∫—Ä–∞—â–µ–Ω—ã –∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã.\\n")
print(f"üìö –°–ø–∏—Å–æ–∫ —Ç–µ–º ({len(topics)} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö):")
for t in topics:
    print(" -", t)

# ---
# –û–±—Ä–∞–±–æ—Ç–∫–∞ nejm_cases.json (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
# ---
if os.path.exists("nejm_cases.json"):
    # ... –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞–Ω–∞–ª–æ–≥–∏—á–Ω—É—é –ª–æ–≥–∏–∫—É –¥–ª—è nejm_cases.json, 
    # –µ—Å–ª–∏ —Ç–µ–º—ã —Ç–∞–º —Ç–æ–∂–µ –Ω—É–∂–Ω–æ —á–∏—Å—Ç–∏—Ç—å
    pass