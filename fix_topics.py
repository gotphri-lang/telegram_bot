import json
import os # <-- Ð­Ñ‚Ð¾Ñ‚ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ Ð¾ÑˆÐ¸Ð±ÐºÑƒ

# ====================================================================
# Ð¨ÐÐ“ 1: Ð¡Ð»Ð¾Ð²Ð°Ñ€ÑŒ Ð´Ð»Ñ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ð¹ Ð² ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ð¸ Ñ Ð¼ÐµÐ´Ð²ÑƒÐ·Ð¾Ð¼
# ====================================================================
TOPIC_MAPPING = {
    # Ð¡Ð¿Ð¾Ñ€Ð½Ñ‹Ðµ/ÐÐµÐ¾Ð±Ñ‰ÐµÐ¿Ñ€Ð¸Ð½ÑÑ‚Ñ‹Ðµ Ñ‚ÐµÐ¼Ñ‹/Ð¡Ð¸Ð½Ð¾Ð½Ð¸Ð¼Ñ‹ (Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ñ‹Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº)
    "Ð¢Ñ€Ð°Ð²Ð¼Ð°": "Ð¥Ð¸Ñ€ÑƒÑ€Ð³Ð¸Ñ",
    "ÐÐµÐ¾Ñ‚Ð»Ð¾Ð¶Ð½Ð°Ñ": "Ð ÐµÐ°Ð½Ð¸Ð¼Ð°Ñ†Ð¸Ñ",
    "ÐÐµÐ¾Ñ‚Ð»Ð¾Ð¶Ð½Ð°Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒ": "Ð ÐµÐ°Ð½Ð¸Ð¼Ð°Ñ†Ð¸Ñ",
    "ÐÐµÑ„Ñ€Ð¾ÑƒÑ€Ð¾Ð»Ð¾Ð³Ð¸Ñ": "ÐÐµÑ„Ñ€Ð¾Ð»Ð¾Ð³Ð¸Ñ",
    "Ð£Ñ€Ð¾Ð»Ð¾Ð³Ð¸Ñ": "ÐÐµÑ„Ñ€Ð¾Ð»Ð¾Ð³Ð¸Ñ",
    "Ð¥Ð¸Ñ€ÑƒÑ€Ð³Ð¸Ñ Ð½Ð¾Ð²Ð¾Ñ€Ð¾Ð¶Ð´Ñ‘Ð½Ð½Ñ‹Ñ…": "Ð¥Ð¸Ñ€ÑƒÑ€Ð³Ð¸Ñ",
    
    # ÐžÐ±ÑŠÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ Ð´Ð¸ÑÑ†Ð¸Ð¿Ð»Ð¸Ð½
    "Ð’Ð°ÐºÑ†Ð¸Ð½Ñ‹": "Ð˜Ð½Ñ„ÐµÐºÑ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ð±Ð¾Ð»ÐµÐ·Ð½Ð¸",
    "Ð’Ð°ÐºÑ†Ð¸Ð½Ð¾Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ð°ÐºÑ‚Ð¸ÐºÐ°": "Ð˜Ð½Ñ„ÐµÐºÑ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ð±Ð¾Ð»ÐµÐ·Ð½Ð¸", 
    "Ð¤Ñ‚Ð¸Ð·Ð¸Ð°Ñ‚Ñ€Ð¸Ñ": "Ð˜Ð½Ñ„ÐµÐºÑ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ð±Ð¾Ð»ÐµÐ·Ð½Ð¸",
    "Ð—Ð¾Ð¾Ð½Ð¾Ð·Ñ‹": "Ð˜Ð½Ñ„ÐµÐºÑ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ð±Ð¾Ð»ÐµÐ·Ð½Ð¸",
    "Ð˜Ð¼Ð¼ÑƒÐ½Ð¾Ð´ÐµÑ„Ð¸Ñ†Ð¸Ñ‚Ñ‹": "Ð˜Ð¼Ð¼ÑƒÐ½Ð¾Ð»Ð¾Ð³Ð¸Ñ",
    "ÐÐ»Ð»ÐµÑ€Ð³Ð¾Ð»Ð¾Ð³Ð¸Ñ": "Ð˜Ð¼Ð¼ÑƒÐ½Ð¾Ð»Ð¾Ð³Ð¸Ñ",
    
    # ÐšÐ°Ñ€Ð´Ð¸Ð¾Ð»Ð¾Ð³Ð¸Ñ / ÐÐµÐ²Ñ€Ð¾Ð»Ð¾Ð³Ð¸Ñ / ÐžÐ½ÐºÐ¾Ð»Ð¾Ð³Ð¸Ñ
    "ÐšÐ°Ñ€Ð´Ð¸Ð¾Ð½ÐµÐ²Ñ€Ð¾Ð»Ð¾Ð³Ð¸Ñ": "ÐÐµÐ²Ñ€Ð¾Ð»Ð¾Ð³Ð¸Ñ",
    "Ð¡Ð¸Ð½ÐºÐ¾Ð¿Ðµ": "ÐšÐ°Ñ€Ð´Ð¸Ð¾Ð»Ð¾Ð³Ð¸Ñ",
    "Ð’ÐŸÐ¡": "ÐšÐ°Ñ€Ð´Ð¸Ð¾Ð»Ð¾Ð³Ð¸Ñ",
    "ÐÑ€Ð¸Ñ‚Ð¼Ð¾Ð»Ð¾Ð³Ð¸Ð¸": "ÐšÐ°Ñ€Ð´Ð¸Ð¾Ð»Ð¾Ð³Ð¸Ñ",
    "ÐÐ”": "ÐšÐ°Ñ€Ð´Ð¸Ð¾Ð»Ð¾Ð³Ð¸Ñ",
    "ÐÐµÐ¹Ñ€Ð¾Ð¾Ð½ÐºÐ¾Ð»Ð¾Ð³Ð¸Ñ": "ÐžÐ½ÐºÐ¾Ð»Ð¾Ð³Ð¸Ñ",
    "Ð“ÐµÐ¼Ð°Ñ‚Ð¾Ð¾Ð½ÐºÐ¾Ð»Ð¾Ð³Ð¸Ñ": "Ð“ÐµÐ¼Ð°Ñ‚Ð¾Ð»Ð¾Ð³Ð¸Ñ",
    
    # ÐŸÐµÐ´Ð¸Ð°Ñ‚Ñ€Ð¸Ñ / Ð£Ð·ÐºÐ¸Ðµ
    "Ð›Ð¾Ñ€": "ÐžÑ‚Ð¾Ñ€Ð¸Ð½Ð¾Ð»Ð°Ñ€Ð¸Ð½Ð³Ð¾Ð»Ð¾Ð³Ð¸Ñ",
    "Ð­Ñ‚Ð¸ÐºÐ°": "ÐœÐµÐ´Ð¸Ñ†Ð¸Ð½ÑÐºÐ°Ñ ÑÑ‚Ð¸ÐºÐ°",
    "Ð¤Ð°Ñ€Ð¼Ð°ÐºÐ¾Ð»Ð¾Ð³Ð¸Ñ": "ÐŸÐµÐ´Ð¸Ð°Ñ‚Ñ€Ð¸Ñ",
    "Ð›Ð°ÐºÑ‚Ð°Ñ†Ð¸Ñ": "ÐŸÐµÐ´Ð¸Ð°Ñ‚Ñ€Ð¸Ñ",
    "ÐÑƒÑ‚Ñ€Ð¸Ñ†Ð¸Ð¾Ð»Ð¾Ð³Ð¸Ñ": "ÐŸÐµÐ´Ð¸Ð°Ñ‚Ñ€Ð¸Ñ",
    "ÐŸÑÐ¸Ñ…Ð¾ÑÐ¾Ð¼Ð°Ñ‚Ð¸ÐºÐ°": "ÐŸÐµÐ´Ð¸Ð°Ñ‚Ñ€Ð¸Ñ",
    
    # Ð“ÐµÐ½ÐµÑ‚Ð¸ÐºÐ°
    "Ð“ÐµÐ½ÐµÑ‚Ð¸ÐºÐ°": "ÐœÐµÐ´Ð¸Ñ†Ð¸Ð½ÑÐºÐ°Ñ Ð³ÐµÐ½ÐµÑ‚Ð¸ÐºÐ°",
    "ÐÐ°ÑÐ»ÐµÐ´ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ðµ": "ÐœÐµÐ´Ð¸Ñ†Ð¸Ð½ÑÐºÐ°Ñ Ð³ÐµÐ½ÐµÑ‚Ð¸ÐºÐ°",
    "Ð¢ÑƒÐ±ÑƒÐ»Ð¾Ð¿Ð°Ñ‚Ð¸Ð¸": "ÐÐµÑ„Ñ€Ð¾Ð»Ð¾Ð³Ð¸Ñ",
    
    # ÐÐµÐ²Ñ€Ð¾Ð»Ð¾Ð³Ð¸Ñ
    "ÐÐµÑ€Ð²Ð½Ð¾-Ð¼Ñ‹ÑˆÐµÑ‡Ð½Ñ‹Ðµ": "ÐÐµÐ²Ñ€Ð¾Ð»Ð¾Ð³Ð¸Ñ",
    "Ð­Ð¿Ð¸Ð»ÐµÐ¿Ñ‚Ð¾Ð»Ð¾Ð³Ð¸Ñ": "ÐÐµÐ²Ñ€Ð¾Ð»Ð¾Ð³Ð¸Ñ",
    "Ð Ð°Ð·Ð²Ð¸Ñ‚Ð¸Ðµ": "ÐÐµÐ²Ñ€Ð¾Ð»Ð¾Ð³Ð¸Ñ"
}

# 1. Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…
try:
    with open("questions.json", encoding="utf-8") as f:
        data = json.load(f)
except FileNotFoundError:
    print("âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð¤Ð°Ð¹Ð» 'questions.json' Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.")
    exit()
except json.JSONDecodeError as e:
    print(f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð´ÐµÐºÐ¾Ð´Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ JSON Ð² 'questions.json': {e}")
    exit()


# 2. ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ‚ÐµÐ¼
for q in data:
    topic = q.get("topic", "").strip()
    
    # 2.1. Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÐºÐ¾Ð¼Ð±Ð¸Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ñ‚ÐµÐ¼Ñ‹ (Ð±ÐµÑ€ÐµÐ¼ Ð¿ÐµÑ€Ð²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾)
    for sep in ["/", ",", "-", "â€”"]:
        if sep in topic:
            topic = topic.split(sep)[0].strip()
    
    # 2.2. ÐŸÑ€Ð¸Ð²Ð¾Ð´Ð¸Ð¼ Ðº ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ð¾Ð¼Ñƒ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ñƒ
    standard_topic = topic.capitalize() 

    # 2.3. ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÐ¼ ÑÐ»Ð¾Ð²Ð°Ñ€ÑŒ Ð·Ð°Ð¼ÐµÐ½
    if standard_topic in TOPIC_MAPPING:
        q["topic"] = TOPIC_MAPPING[standard_topic]
    else:
        q["topic"] = standard_topic


# 3. Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ° Ð¿Ð¾ Ñ‚ÐµÐ¼Ðµ Ð¸ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÑŒ Ñ„Ð°Ð¹Ð»Ð°
data.sort(key=lambda x: x.get("topic", "").lower())

with open("questions.json", "w", encoding="utf-8") as f:
    json.dump(data, f, ensure_ascii=False, indent=2)

# 4. Ð’Ñ‹Ð²Ð¾Ð´ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°
topics = sorted(set(q["topic"] for q in data))
print("âœ… Ð¢ÐµÐ¼Ñ‹ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹, ÑÐ¾ÐºÑ€Ð°Ñ‰ÐµÐ½Ñ‹ Ð¸ Ð¾Ñ‚ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹.\\n")
print(f"ðŸ“š Ð¡Ð¿Ð¸ÑÐ¾Ðº Ñ‚ÐµÐ¼ ({len(topics)} ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ñ…):")
for t in topics:
    print(" -", t)

# ---
# ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° nejm_cases.json (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾)
# ---
if os.path.exists("nejm_cases.json"):
    # Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ ÑÑŽÐ´Ð° Ð»Ð¾Ð³Ð¸ÐºÑƒ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ nejm_cases, ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾ Ð¿Ð¾Ñ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ñ‚ÐµÐ¼Ñ‹ Ð¸ Ñ‚Ð°Ð¼.
    pass